
{% import _self as menus %}
{% set attributes = attributes.addClass('menu') %}

<div class="side-menu">
  {{ menus.menu_links(items, attributes, 0, 'side-menu-item-', mega_menu_content) }}
</div>

{% macro menu_links(items, attributes, menu_level, aria_id, mega_menu_content) %}

  {% set main_nav_level = 'side-menu__list--level-' ~ (menu_level + 1) %}
  {% set drupal_selector_main_nav_level = menu_level <= 1 ? 'default-nav-menu--level-' ~ (menu_level + 1) : false %}
  {% set is_top_level_menu = menu_level == 0 %}
  {% set list_classes = [
    'side-menu__list',
    main_nav_level,
  ] %}
  {% import _self as menus %}
  {% if items %}

    <ul{{ attributes.addClass(list_classes).setAttribute('data-drupal-selector', drupal_selector_main_nav_level) }}>
      {% set attributes = attributes.removeClass(main_nav_level) %}
      {% for item in items %}

        {% if item.url.isRouted and item.url.routeName == '<nolink>' %}
          {% set menu_item_type = 'nolink' %}
        {% elseif item.url.isRouted and item.url.routeName == '<button>' %}
          {% set menu_item_type = 'button' %}
        {% else %}
          {% set menu_item_type = 'link' %}
        {% endif %}

        {% set item_classes = [
            'side-menu__list-item',
            'side-menu__list-item--' ~ menu_item_type,
            'side-menu__list-item--level-' ~ (menu_level + 1),
            item.in_active_trail ? 'side-menu__list-item--active-trail',
            item.below ? 'side-menu__list-item--has-children',
          ]
        %}

        {% set link_classes = [
            'side-menu__link',
            'side-menu__link--' ~ menu_item_type,
            'side-menu__link--level-' ~ (menu_level + 1),
            item.in_active_trail ? 'side-menu__link--active-trail',
            item.below ? 'side-menu__link--has-children',
          ]
        %}

        <li{{ item.attributes.addClass(item_classes).setAttribute('data-drupal-selector', is_top_level_menu and item.below ? 'side-menu-item-has-children': false) }}>
          {% set aria_id = (aria_id ~ loop.index )|clean_unique_id %}
          {% set is_parent_button = item.below and menu_item_type == 'button' %}
          {% set link_title %}
            {{ item.title }}
            {% if is_parent_button %}
              <span class="side-menu__button-icon"></span>
            {% endif %}
          {% endset %}

          {{ link(link_title, item.url, {
            'class': link_classes,
            'data-drupal-selector': item.below ? 'side-menu-link-has-children' : false,
            'aria-controls': is_parent_button ? aria_id : false,
            'aria-expanded': is_parent_button and item.in_active_trail ? 'true' : 'false',
            })
          }}

          {% if item.below %}
            {# If top level <a> element and has submenu, insert <button> element to toggle the submenu. #}
            {% if menu_item_type != 'button' %}
              {% set toggle_button_attributes = create_attribute({
                'class': 'side-menu__button-toggle',
                'data-drupal-selector': 'default-submenu-toggle-button',
                'aria-controls': aria_id,
                'aria-expanded': item.in_active_trail ? 'true' : 'false',
              }) %}

              <button{{ toggle_button_attributes }}>
                <span class="side-menu__button-icon"></span>
                <span class="visually-hidden">{{ '@title sub-navigation'|t({'@title': item.title}) }}</span>
              </button>
            {% endif %}
            {% set attributes = attributes.setAttribute('id', aria_id) %}
            {{ menus.menu_links(item.below, attributes, menu_level + 1, aria_id, item_mega_menu_content) }}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}
